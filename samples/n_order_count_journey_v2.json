{
  "createTime": 1701876660119,
  "updateTime": 1701885377840,
  "accessPolicy": {},
  "name": "n_orders_journey_workflow",
  "description": "This WF will update the journey order count and if it reaches a milestone, announces it.",
  "version": 7,
  "tasks": [
    {
      "name": "get_challenge_order_count_http_task",
      "taskReferenceName": "get_challenge_order_count_http_task_ref",
      "inputParameters": {
        "http_request": {
          "uri": "http://localhost:8081/v1/customer/${workflow.input.customerId}/journey/${workflow.input.journeyId}",
          "method": "GET"
        }
      },
      "type": "HTTP",
      "startDelay": 0,
      "optional": false,
      "asyncComplete": false
    },
    {
      "name": "increment_order_count_by_one",
      "taskReferenceName": "increment_order_count_by_one_ref",
      "inputParameters": {
        "expression": "(function(){ var existingMeta = $.meta;  var emailSender = $.email_sender; var existingCount = existingMeta[emailSender]; var newCount = 1; if (existingCount !== undefined) { newCount = existingCount + 1;} existingMeta[emailSender] = newCount;  return  existingMeta;})();",
        "evaluatorType": "javascript",
        "meta": "${get_challenge_order_count_http_task_ref.output.response.body.response.meta}",
        "email_sender": "${workflow.input.email_sender}"
      },
      "type": "INLINE",
      "startDelay": 0,
      "optional": false,
      "asyncComplete": false
    },
    {
      "name": "update_journey_order_count_http_task",
      "taskReferenceName": "update_journey_order_count_http_task_ref",
      "inputParameters": {
        "http_request": {
          "uri": "http://localhost:8081/v1/customer/${workflow.input.customerId}/journey/${workflow.input.journeyId}",
          "method": "PUT",
          "body": {
            "customerId": "${workflow.input.customerId}",
            "workflowId": "${workflow.input.workflowId}",
            "journeyId": "${workflow.input.journeyId}",
            "meta": "${increment_order_count_by_one_ref.output.result}"
          }
        }
      },
      "type": "HTTP",
      "startDelay": 0,
      "optional": false,
      "asyncComplete": false
    },
    {
      "name": "is_milestone_order_switch_task",
      "taskReferenceName": "is_milestone_order_switch_task_ref",
      "inputParameters": {
        "orderCount": "${increment_order_count_by_one_ref.output.result}",
        "count": "${increment_order_count_by_one_ref.output.result.${workflow.input.email_sender}}",
        "email_sender": "${workflow.input.email_sender}"
      },
      "type": "SWITCH",
      "decisionCases": {
        "milestone_order": [
          {
            "name": "announce_milestone_http_task",
            "taskReferenceName": "announce_milestone_http_task_ref",
            "inputParameters": {
              "http_request": {
                "uri": "http://localhost:8081/v1/announce",
                "method": "POST",
                "connectionTimeOut": 3000,
                "readTimeOut": "3000",
                "accept": "application/json",
                "contentType": "application/json",
                "body": {
                  "workflowId": "${workflow.input.workflowId}",
                  "journeyId": "${workflow.input.journeyId}",
                  "meta": {
                    "count": "${increment_order_count_by_one_ref.output.value}",
                    "email_sender": "${workflow.input.email_sender}"
                  }
                }
              },
              "startDelay": 0,
              "optional": false,
              "asyncComplete": false
            },
            "type": "HTTP",
            "startDelay": 0,
            "optional": false,
            "asyncComplete": false
          }
        ]
      },
      "startDelay": 0,
      "optional": false,
      "asyncComplete": false,
      "evaluatorType": "javascript",
      "expression": "function isMilestoneOrder() {var existingMeta = $.orderCount;  var emailSender = $.email_sender; var orderCount = parseInt(existingMeta[emailSender]); var milestones = [5, 10, 15, 25, 50, 100];  if (milestones.indexOf(orderCount) !== -1) {    return 'milestone_order';  }  return 'non_milestone_order';} isMilestoneOrder();"
    }
  ],
  "inputParameters": [
    "workflowId",
    "customerId",
    "journeyId"
  ],
  "outputParameters": {
    "finalOrderCount": "${increment_order_count_by_one_ref.output.value}"
  },
  "failureWorkflow": "",
  "schemaVersion": 2,
  "restartable": true,
  "workflowStatusListenerEnabled": false,
  "ownerEmail": "aniket@flash.tech",
  "timeoutPolicy": "ALERT_ONLY",
  "timeoutSeconds": 30,
  "variables": {},
  "inputTemplate": {}
}